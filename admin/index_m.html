<html>
<link rel="stylesheet" type="text/css" href="../../css/adapter.css"/>
<link rel="stylesheet" type="text/css" href="../../lib/css/materialize.css">

<script type="text/javascript" src="../../lib/js/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="../../socket.io/socket.io.js"></script>

<script type="text/javascript" src="../../js/translate.js"></script>
<script type="text/javascript" src="../../lib/js/materialize.js"></script>
<script type="text/javascript" src="../../js/adapter-settings.js"></script>
<script type="text/javascript" src="words.js"></script>


<style>
    .table_header {
        background-color: blue;
        color: white;
    }
    .ip {
        width: 150px;
        text-align: right;
    }
</style>
<!-- you have to define 2 functions in the global scope: -->
<script type="text/javascript">
    var setup = [];
    // the function loadSettings has to exist ...
    function save(callback) {
            var obj = {};
            $('.value').each(function () {
                var $this = $(this);
                var id = $this.attr('id');
                if ($this.attr('type') === 'checkbox') {
                    obj[$this.attr('id')] = $this.prop('checked');
                } else {
                    obj[$this.attr('id')] = $this.val();
                }
            });
            callback(obj);
        }
    
        function load(settings, onChange) {
            const request = require('request');

            if (!settings) return;
            $('.value').each(function () {
                var key = $(this).attr('id');
                var $key = $('#' + key + '.value');
                if ($key.attr('type') === 'checkbox') {
                    $key.prop('checked', settings[key]).change(function () {
                        onChange();
                    });
                } else {
                    $key.val(settings[key]).change(function () {
                        onChange();
                    }).keyup(function () {
                        onChange();
                    });
                }
            });
            onChange(false);


            $('#loadRegions').on('click', function () {
                var $loadRegions = $('#loadRegions');
                let country = $('#country').val();

                if (typeof (country) == 'undefinded' || country == '') {
                    //$getDevices.removeClass('disabled');
                    //$('#loader1').addClass('seenot');
                    showToast(_('No country selected'));
                    return
                }
                else{
                    requestXML()

                    
                }



            });



        }

        function requestXML(){
            var url = 'https://www.meteoalarm.eu/documents/rss/at.rss'
            adapter.log.info('Requesting data from ' + url)
        request.post({
            url:     url,
            timeout: 8000
          }, function(error, response, body){
            if (error){
                if (error.code === 'ETIMEDOUT'){
                    adapter.log.error('No website response after 8 seconds. Adapter will try again at next scheduled run.')
                    adapter.terminate ? adapter.terminate(0) : process.exit(0);
                }
                else if (error.code === 'ESOCKETTIMEDOUT'){
                    adapter.log.error('No website response after 8 seconds. Adapter will try again at next scheduled run.')
                    adapter.terminate ? adapter.terminate(0) : process.exit(0);
                }
                else(
                    adapter.log.error(error)
                    
                )
            }
            if (body) {
                parseString(body, {
    
                    explicitArray: false,
    
                    mergeAttrs: true
    
                }, 
    
                function (err, result) {
    
                    if (err) {
    
                        adapter.log.error("Fehler: " + err);
                        adapter.terminate ? adapter.terminate(0) : process.exit(0);
                    } else {
                        showToast(_('received xml for'   + country));
                    }
                });
            }
          });    
        }
   
        }

            
        


        function fillRegions() {
            let regions;
            let text = "";
            let country = $('#country').val();

            showToast(_('pressed loadregions for'   + country));

            /*
            try {
                devices = JSON.parse($('#MiDevice').val())
            } catch (e) {
                console.log('cant parse devices');
                return
            }
            if(Array.isArray(devices)){
                devices.forEach(function (entry) {
                        text += "<option value='" + JSON.stringify(entry) + "' >" + entry
                            .model + ' - token: ' + entry.token + ' - ip: ' + (entry.localip ?
                                entry.localip : '') + '</option>';

                        //check if in config
                    })
                    $('#devices').html(text).select();*/
                    $('#regions').html('test').select();
            }
</script>
<style>
    .m .select-wrapper+label {
        top: 100%;
    }
</style>
</head>
<body>
<div class="m adapter-container">
    <div class="row">
        <div class="row">
            <div class="input-field col s3">
                <img src="meteoalarm.png" class="logo">
            </div>
        </div>
    </div>
    <div class="row">
        <div class="input-field col s12 m4 l2 ">
            <select class="value " id="country" type="text">
                <option value="" disabled selected class="translate">country</option>
                <option value="AT">Austria</option>
                <option value="DE">Germany</option>
                <option value="CH">Switzerland</option>
                <option value="FI">Finnland</option>
            </select>
            <label class="translate" for="country">country</label>
        </div>
        <div class="col s5 m3 l2">
            <a id="loadRegions" class=" btn-small translate">load regions<span></span></a>
        </div>
    </div>
    <div class="row">
        <div class="col s12 m12 l12 input-field">
            <select class="value " id="regions" type="text">
                <option value="" disabled selected class="translate">Please select Country first</option>
            </select>
            <label class="translate" for="regions">regions</label>
        </div>
    </div>
    <div class="row">
        <div class="input-field col s12">
            <input type="text" id="pathXML" class="value" />
            <label for="pathXML" class="translate">AddPath</label>
        </div>
    </div>
    <div class="row">
        <div class="col s12">
            <span class="translate">instruction</span>
        </div>
    </div>
</div>
</body>
</html>