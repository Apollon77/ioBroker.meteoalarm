<html>
<link rel="stylesheet" type="text/css" href="../../css/adapter.css"/>
<link rel="stylesheet" type="text/css" href="../../lib/css/materialize.css">

<script type="text/javascript" src="../../lib/js/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="../../socket.io/socket.io.js"></script>

<script type="text/javascript" src="../../js/translate.js"></script>
<script type="text/javascript" src="../../lib/js/materialize.js"></script>
<script type="text/javascript" src="../../js/adapter-settings.js"></script>
<script type="text/javascript" src="words.js"></script>


<style>
    .table_header {
        background-color: blue;
        color: white;
    }
    .ip {
        width: 150px;
        text-align: right;
    }
</style>
<!-- you have to define 2 functions in the global scope: -->
<script type="text/javascript">
    var setup = [];
    var regionArray = [];
    var regionLinkArray = [];

    // the function loadSettings has to exist ...
    function save(callback) {
            var obj = {};
            $('.value').each(function () {
                var $this = $(this);
                var id = $this.attr('id');
                if ($this.attr('type') === 'checkbox') {
                    obj[$this.attr('id')] = $this.prop('checked');
                } else {
                    obj[$this.attr('id')] = $this.val();
                }
            });
            callback(obj);
        }
    
        function load(settings, onChange) {
            if (!settings) return;
            $('.value').each(function () {
                var key = $(this).attr('id');
                var $key = $('#' + key + '.value');
                if ($key.attr('type') === 'checkbox') {
                    $key.prop('checked', settings[key]).change(function () {
                        onChange();
                    });
                } else {
                    $key.val(settings[key]).change(function () {
                        onChange();
                    }).keyup(function () {
                        onChange();
                    });
                }
            });
            onChange(false);

            $('#regions').change(function () {
                console.log("changed region to " + regionArray[this] + regionLinkArray[this])
                setValue('pathXML', regionLinkArray[this] , onChange);
            });

            /*
            document.addEventListener('DOMContentLoaded', function() {
                var elems = document.querySelectorAll('select');
                var instances = M.FormSelect.init(elems, options);
            });
            */

            $('#loadRegions').on('click', function () {
                var $loadRegions = $('#loadRegions');
                var $regionList = $('#regions')
                regionArray = [];
                regionLinkArray = [];
                $('#loader1').removeClass('seenot');
                $loadRegions.addClass('disabled');
                var $loadRegions = $('#loadRegions');
                let country = $('#country').val();
                console.log("pressed loadregions for  " + country);
                let url = 'https://www.meteoalarm.eu/documents/rss/' + country + '.rss'
                httpGet(url, function(returnValue) {
                    console.log(returnValue);
                    let xml = returnValue
                    let text = "";
                    var i = 0
                    $(xml).find('item').each(function(){
                        if (i != 0){
                            text += $(xml).find("title").text()
                            //$('#region').add($(xml).find("title").text(), i);


                            var $option = $("<option/>", {
                                        value: i,
                                        text: $(xml).find("title").text()
                            });
                            //$('#regions').append($option);
                            $('#regions').append('Test');
                            //M.updateText
                            regionArray.push($(xml).find("title").text());
                            regionLinkArray.push($(xml).find("link").text());
                        }
                        i += 1
                    });
                    //$('#regionList').html(text).select()
                    //$("select").$regionList("destroy").$regionList();
                    $regionList.append('Test1');
                    $('.mdb-select').material_select();
                    //$('#regions').select()
                    //$regionList.destroy()

                    showToast(_(i + ' regions updated'));
                    $loadRegions.removeClass('disabled');
                    $('#loader1').addClass('seenot');
                });
            });
        }

        function httpGet(theUrl, callback)
        {
            theUrl =  'https://cors-anywhere.herokuapp.com/' + theUrl
            console.log('Used URL: ' + theUrl)
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.open( "GET", theUrl, false ); 
            xmlHttp.send( null );
            callback(xmlHttp.responseXML);
        }           

</script>
<style>
    .m .select-wrapper+label {
        top: 100%;
    }

    .loader {
            border: 4px solid #b8d1f3;
            /* Light grey */
            border-top: 4px solid #3498db;
            /* Blue */
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 2s linear infinite;
        }

        .seenot {
            display: none;
        }
</style>
</head>
<body>
<div class="m adapter-container">
    <div class="row">
        <div class="row">
            <div class="input-field col s3">
                <img src="meteoalarm.png" class="logo">
            </div>
        </div>
    </div>
    <div class="row">
        <div class="input-field col s12 m4 l2 ">
            <select class="value " id="country" type="text">
                <option value="" disabled selected class="translate">country</option>
                <option value="at">Austria</option>                
                <option value="hr">Croatia</option>
                <option value="cz">Czech Republic</option>
                <option value="fi">Finnland</option>
                <option value="de">Germany</option>
                <option value="gr">Greece</option>
                <option value="hu">Hungary</option>
                <option value="ie">Ireland</option>
                <option value="il">Israel</option>
                <option value="it">Italy</option>
                <option value="lv">Latvia</option>
                <option value="lt">Lithuania</option>
                <option value="mt">Malta</option>
                <option value="md">Moldova</option>
                <option value="me">Montenegro</option>
                <option value="nl">Netherlands</option>
                <option value="no">Norwege</option>
                <option value="pl">Poland</option>
                <option value="ro">Romania</option>
                <option value="rs">Serbia</option>
                <option value="si">Slovakia</option>
                <option value="es">Spain</option>
                <option value="ch">Switzerland</option>
                <option value="se">Sweden</option>
            </select>
            <label class="translate" for="country">country</label>
        </div>
        <div class="col s5 m3 l2">
            <a id="loadRegions" class=" btn-small translate">load regions<span></span></a>
        </div>
        <div class="col s2 ">
            <div class="loader seenot" id="loader1"> </div>
        </div>
    </div>
    <div class="row">
        <div class="col s12 m12 l12 input-field">
            <select class="mdb-select " id="regions" type="text">
                <option value="" disabled selected class="translate">Please select Country first</option>
            </select>
            <label class="translate" for="regions">regions</label>
        </div>
    </div>
    <div class="row">
        <div class="input-field col s12">
            <input type="text" id="pathXML" class="value" />
            <label for="pathXML" class="translate">AddPath</label>
        </div>
    </div>
    <div class="row">
        <div class="col s12">
            <span class="translate">instruction</span>
        </div>
    </div>
</div>
</body>
</html>